<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Codebot</title>
  <link rel="icon" href="image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üß†</text></svg>">
  <style>
:root {
      --bg: #121212;
      --card: #1e1e1e;
      --fg: #e0e0e0;
      --accent: #646cff;
      --error: #ff6b6b;
      --success: #4caf50;
      --warning: #FFA500;
}
    * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Fira Code', monospace, sans-serif;}
    body {
      background: var(--bg);
      color: var(--fg);
      padding: 24px;
      max-width: 900px;
      margin: 0 auto;
}
    header {
      text-align: center;
      margin-bottom: 28px;
      padding-bottom: 16px;
      border-bottom: 1px solid #333;
}
    h1 {
      font-size: 2.2rem;
      background: linear-gradient(90deg, var(--accent), #4ade80);
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      margin-bottom: 8px;
}
.subtitle {
      color: #aaa;
      font-size: 1rem;
}
.container {
      display: flex;
      flex-direction: column;
      gap: 16px;
}
    textarea {
      width: 100%;
      min-height: 180px;
      background: var(--card);
      color: white;
      border: 1px solid #444;
      border-radius: 8px;
      padding: 16px;
      resize: vertical;
      font-size: 14px;
}
    select {
      padding: 8px;
      background: var(--card);
      color: white;
      border: 1px solid #444;
      border-radius: 4px;
}
    button {
      background: var(--accent);
      color: white;
      border: none;
      padding: 10px 16px;
      border-radius: 6px;
      font-weight: bold;
      cursor: pointer;
      margin-top: 4px;
}
    button:hover { opacity: 0.9;}
.button-group {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
}
.ai-button {
      background: #9c27b0;
}
.ai-button:hover { opacity: 0.9;}
    #output {
      background: var(--card);
      padding: 18px;
      border-radius: 8px;
      white-space: pre-wrap;
      font-size: 14px;
      line-height: 1.5;
      min-height: 80px;
}
.success { color: var(--success);}
.error { color: var(--error);}
.warning { color: var(--warning);}
.loading {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid rgba(255,255,255,.3);
        border-radius: 50%;
        border-top-color: var(--accent);
        animation: spin 1s ease-in-out infinite;
}
    @keyframes spin {
        to { transform: rotate(360deg);}
}
  </style>
</head>
<body>
  <header>
    <h1>Codebot</h1>
    <p class="subtitle">Offline Code Helper ‚Ä¢ Zero AI ‚Ä¢ 100% in Browser</p>
  </header>

  <div class="container">
    <select id="lang">
      <option value="js">JavaScript</option>
      <option value="jsx">React (JSX)</option>
      <option value="py">Python</option>
      <option value="java">Java</option>
      <option value="cpp">C++</option>
      <option value="go">Go</option>
    </select>
    <textarea id="code" placeholder="Paste your code here..."></textarea>

    <div class="button-group">
      <button class="ai-button" onclick="explainCode()">Explain Code</button>
      <button class="ai-button" onclick="fixCode()">Check & Fix</button>
    </div>

    <div id="output">Results will appear here.</div>
  </div>

  <script>
    const GEMINI_API_KEYS = [
        'AIzaSyAyv8qonM9cb_qaUxJ3mTjAvo3i80MqiOs',
        'AIzaSyDOkyuOuZwbYA2QUBc49gZ08z0rLQC4XUY',
        'AIzaSyD-dBra0bz0nYCvpeJvfpVcliUC16egTwQ'
    ]; 
    const OLLAMA_API_URL = 'http://localhost:11434/api/generate'; 
    const OLLAMA_MODEL = 'phi3:mini'; 

    async function callGeminiAPI(prompt, apiKey) {
        const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`;
        const requestBody = {
            contents: [{
                parts: [{
                    text: prompt
                }]
            }]
        };

        try {
            const response = await fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(requestBody),
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(`Gemini Error (${response.status}): ${errorData.error?.message || 'Unknown error'}`);
            }

            const data = await response.json();
            const text = data.candidates?.[0]?.content?.parts?.[0]?.text || "Gemini did not return a valid response.";
            
            if (text.includes("Gemini did not return a valid response.")) {
                 throw new Error(`Gemini Error: Empty or invalid response from model.`);
            }

            return text.trim();
        } catch (error) {
            throw error;
        }
    }

    async function callOllamaAPI(prompt, model = OLLAMA_MODEL) {
        const requestBody = {
            model: model,
            prompt: prompt,
            stream: false
        };

        try {
            const response = await fetch(OLLAMA_API_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(requestBody),
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(`Ollama Error (${response.status}): ${errorData.error || 'Unknown error'}`);
            }

            const data = await response.json();
            const text = data.response || "Ollama did not return a valid response.";
            return text.trim();
        } catch (error) {
            throw error;
        }
    }

    async function callAIWithFallback(prompt, outElement) {
        let aiResponse = null;
        let errors = [];

        for (let i = 0; i < GEMINI_API_KEYS.length; i++) {
            const apiKey = GEMINI_API_KEYS[i];
            
            if (i > 0) {
                 outElement.innerHTML = `<span class="warning">Backend is loading... trying key ${i + 1}</span> <div class="loading"></div>`;
            }

            try {
                console.log(`Trying Gemini Key ${i + 1}...`);
                aiResponse = await callGeminiAPI(prompt, apiKey);
                // Source impostata su "text generated from /data" per le risposte di Gemini
                return { response: aiResponse, source: "text generated from /data" }; 
            } catch (geminiError) {
                console.warn(`Gemini Key ${i + 1} failed:`, geminiError.message);
                errors.push(`- Gemini Key ${i + 1}: ${geminiError.message}`);
            }
        }

        try {
            outElement.innerHTML = `<span class="warning">Backend is loading... trying Ollama</span> <div class="loading"></div>`;
            console.log("All Gemini keys failed, trying Ollama...");
            aiResponse = await callOllamaAPI(prompt);
            // Source rimane "Ollama" se questo fallback funziona
            return { response: aiResponse, source: "Ollama" };
        } catch (ollamaError) {
            console.error("Ollama also failed.", ollamaError.message);
            errors.push(`- Ollama: ${ollamaError.message}`);
            
            return `‚ùå Backend is down now please try again later.`;
        }
    }

    async function explainCode() {
        const code = document.getElementById('code').value.trim();
        const lang = document.getElementById('lang').value;
        const out = document.getElementById('output');

        if (!code) {
            out.innerHTML = '<span class="error">‚ö†Ô∏è Paste code first.</span>';
            return;
        }

        out.innerHTML = '<span class="warning">Backend is loading... trying key 1</span> <div class="loading"></div>';

        const prompt = `You are a programming assistant. Provide a brief explanation of what the following ${lang.toUpperCase()} code does. Focus on the main logic and purpose. The code is:\n\n\`\`\`${lang}\n${code}\n\`\`\``;

        const result = await callAIWithFallback(prompt, out);

        if (typeof result === 'string' && result.startsWith('‚ùå')) {
            out.innerHTML = `<span class="error">${result}</span>`;
        } else {
            out.innerHTML = `<span class="success">${result.source} Explanation:</span>\n\n${result.response}`;
        }
    }

    async function fixCode() {
        const code = document.getElementById('code').value.trim();
        const lang = document.getElementById('lang').value;
        const out = document.getElementById('output');

        if (!code) {
            out.innerHTML = '<span class="error">‚ö†Ô∏è Paste code first.</span>';
            return;
        }

        out.innerHTML = '<span class="warning">Backend is loading... trying key 1</span> <div class="loading"></div>';

        const prompt = `You are a programming assistant. Analyze the following ${lang.toUpperCase()} code. If there are any errors (syntax, logic, best practice issues, etc.), explain them briefly and provide the corrected code. If the code seems correct, respond with "Code seems good üëçüòä" and provide the original code. The code is:\n\n\`\`\`${lang}\n${code}\n\`\`\``;

        const result = await callAIWithFallback(prompt, out);

        if (typeof result === 'string' && result.startsWith('‚ùå')) {
            out.innerHTML = `<span class="error">${result}</span>`;
        } else {
            let fixedCode = null;
            let displayResponse = result.response;

            const codeBlockRegex = /```(?:\w+\n)?([\s\S]*?)```/;
            const match = result.response.match(codeBlockRegex);
            if (match) {
                fixedCode = match[1].trim();
                if (fixedCode === code && result.response.includes("Code seems good")) {
                    displayResponse = "Code seems good üëçüòä";
                    out.innerHTML = `<span class="success">${displayResponse}</span>`;
                } else {
                    displayResponse = result.response.replace(codeBlockRegex, '').trim();
                    let outputHTML = `<span class="success">${result.source} Response:</span>\n\n${displayResponse}`;
                    outputHTML += `\n\n----------\n\n<span class="success">Suggested Fix:</span>\n\n\`\`\`${lang}\n${fixedCode}\n\`\`\`\n\n<button onclick="applyFix()">Apply This Fix</button>`;
                    out.innerHTML = outputHTML;
                }
            } else {
                if (result.response.includes("Code seems good")) {
                    out.innerHTML = `<span class="success">${result.response}</span>`;
                } else {
                    out.innerHTML = `<span class="success">${result.source} Response:</span>\n\n${result.response}`;
                }
            }
        }
    }

    function applyFix() {
        const out = document.getElementById('output');
        const textContent = out.textContent;
        const codeBlockRegex = /```(?:\w+\n)?([\s\S]*?)```/;
        const match = textContent.match(codeBlockRegex);
        if (match) {
            const newCode = match[1].trim();
            document.getElementById('code').value = newCode;
            out.innerHTML += `\n\n<span class="success">‚úÖ Code updated in the editor.</span>`;
        } else {
            out.innerHTML += `\n\n<span class="error">‚ùå No fix available to apply.</span>`;
        }
    }
  </script>
</body>
</html>
